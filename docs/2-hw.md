## riscv의 하드웨어를 알아보자

작성자: kkongnyang2 작성일: 2025-06-25

---
### 0> 구조
```
┌────────────────────────────────────────────────────────────────────────────┐
│                               SoC / 칩 전체                                │
│                                                                            │
│  ┌────────────────────────── CPU Core ───────────────────────────┐         │
│  │ ┌──────┐   ┌───────────┐   ┌────────┐   ┌────────┐            │         │
│  │ │L1 I$ │──▶│Fetch / BP │──▶│ Decode │──▶│ Rename │──┐         │         │
│  │ └──────┘   └───────────┘   └────────┘   └────────┘  │         │         │
│  │                                                   ┌─▼────────┐│         │
│  │ ┌──────┐   ┌───────────┐   ┌────────┐   ┌──────┐ │ Reorder   │         │
│  │ │L1 D$ │◀──│Load/Store │◀──│  TLB   │──▶│ MMU  │ │  Buffer   │         │
│  │ └──────┘   └───────────┘   └────────┘   └──────┘ └─▲────────┘│         │
│  │              ▲           ▲             ▲            │         │         │
│  │              │           │             │            │         │         │
│  │ ┌──────┐   ┌─┴───┐   ┌───┴───┐   ┌────┴──┐   ┌─────┴───┐     │         │
│  │ │ Int  │   │ SIMD │   │  FPU  │   │  ALU  │   │Branch   │     │         │
│  │ │ ALU  │   │/Vec  │   │        │   │ (INT) │   │Exec/Pred│     │         │
│  │ └──────┘   └──────┘   └────────┘   └────────┘   └────────┘     │         │
│  └─────────────────────────────────────────────────────────────────┘         │
│            │              │                              │                  │
│            │              │                      인터럽트 라인              │
│            │              ▼                              │                  │
│  ┌──────────────────────── System Interconnect / 버스 ─────────────────────┐│
│  │   L2/L3 Cache   │   DRAM Controller   │   Coherent / Non-coherent NoC   ││
│  └──────────────────────────────────────────────────────────────────────────┘│
│            │                                                                │
│  ┌────────────────────────── Memory-Mapped I/O (MMIO) ─────────────────────┐│
│  │  UART │ GPIO │ SPI │ I2C │ Timer │ Interrupt Ctrl │ PCIe │ …            ││
│  └──────────────────────────────────────────────────────────────────────────┘│
└──────────────────────────────────────────────────────────────────────────────┘
```
Legend:
  I$ / D$ : Instruction / Data Cache
  BP      : Branch Predictor
  TLB     : Translation Lookaside Buffer
  MMU     : Memory Management Unit

---
### CPU 내부 유닛(CSR)

연산블록 ALU, FPU /모든 모드
제어블록 MMU /M모드가 껐다킴. S나 U는 설정된 테이블 하에서 사용
캐시블록 L1/L2 Cache 
타이머블록 timer CSR /원래는 M모드만이지만 S로 확장됨
인터럽트블록 CLINT /M S 모두

이걸 동작하는 방법. CSR들 활용. cpu 코어 안에 하드웨어로 존재하는 특수 레지스터들
csrr rd, <csr#>로 읽고 씀
mstatus, sstatus : 특권 모드, 인터럽트 활성 플래그
stvec, mtvec : trap/interrupt 벡터 주소
satp : MMU 루트 페이지테이블
mtime, stimecmp : 사이클, 카운터, 타이머 비교
scause, sepc, stval : trap 원인, 복귀 pc, 오류 값

---
### CPU 외부 유닛(MMIO)

MMIO들은 그냥 주소를 읽으면 레지스터에 연결되어 동작 가능
lw rd, 0(xaddr) (일반 메모리 Load/Store)
```
CPU ──(AXI/AHB/TileLink 버스)──►
       ├─ DRAM 컨트롤러 (0x8000_0000…)
       ├─ UART0 (0x1000_0000) : 시리얼 콘솔이라는 단순 I/O
       ├─ VirtIO 블록 (0x1000_1000) : paravirtual 장치 표준
       └─ PLIC(외부 인터럽트) (0x0C00_0000)
```

---
### CLINT vs PLIC

CLINT는 MSIP/SSIP/MTIP/STIP 소프트웨어와 타이머 인터럽트를 처리하고, 코어 내부의 0x02000000에 있다.
PLIC는 외부 디바이스 IRQ (UART, VirtIO) 를 처리하고, 0x0C000000에 있다.


---
### MMU

물리 주소 = DRAM 칩, MMIO 레지스터를 전선 번호로 직접 가리키는 값
가상 주소 = CPU에서 실행 중인 프로그램이 보는 주소
MMU = CPU 안에 붙어 있는 유닛. 주소 매핑 및 권한 체크.

왜 가상 주소가 필요할까?
실행 파일을 항상 가상주소 0x400000에 배치한다 해도 실제 물리는 RAM 빈곳으로 매핑만 하면 끝

risc-v 64비트 예
Sv39 = 가상주소 39bit(9+9+9+12) 구조
나머지 [64:39] 비트는 sign-extension(최상위 비트 복제)
[38:30] 은 vpn[2] level2(루트) PTE 인덱스
[29:21] 은 vpn[1] level1 PTE 인덱스
[20:12] 은 vpn[0] level0 PTE 인덱스
[11:0] 은 page offset 페이지(4KB) 내부 바이트 위치

따라서 256TB 주소공간.


커널을 로드하는 0x80000000은 물리 주소, 프로세스를 실행하는 0x00000000은 가상 주소이다.
