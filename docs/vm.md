가상머신? 물리적 컴퓨터 위에서 돌아가는 소프트웨어 컴퓨터

하이퍼바이저 -> 그 가짜 컴퓨터를 관리하는 관리자


가상머신 구조

type 1. 네이티브 구조
하드웨어 바로 위에 하이퍼바이저가 동작. os 설치 없이 바로 vm 실행 가능

 [물리 컴퓨터]
 ┌────────────────────────────┐
 │        Hypervisor          │  ← 하이퍼바이저 (Xen, VMware ESXi, Hyper-V)
 │  ┌────────────┐ ┌────────┐ │
 │  │ VM #1      │ │ VM #2 │ │
 │  │ Ubuntu     │ │ Win10 │ │  ← 가상머신 (게스트 OS + 커널)
 │  └────────────┘ └────────┘ │
 └────────────────────────────┘

하드웨어
  ↓
Hypervisor (bare-metal)
  ↓
게스트 OS1 / OS2
  ↓
각 OS의 프로세스


type 2. 호스트 구조
일반 os 위에서 프로그램처럼 실행되는 하이퍼바이저

 [물리 컴퓨터]
 ┌────────────────────────────┐
 │       Host OS (예: Ubuntu) │  ← 일반 데스크탑 OS
 │  ┌──────────────────────┐  │
 │  │ Hypervisor           │  │  ← 소프트웨어 기반 (QEMU, VirtualBox)
 │  │  ┌────────────┐      │  │
 │  │  │ VM #1      │      │  │
 │  │  │ Fedora     │      │  │  ← 게스트 OS
 │  │  └────────────┘      │  │
 │  └──────────────────────┘  │
 └────────────────────────────┘

하드웨어
  ↓
호스트 OS
  ↓
Hypervisor (소프트웨어, 예: QEMU)
  ↓
게스트 OS1 / OS2
  ↓
각 OS의 프로세스


type 3. 컨테이너 구조
모두 호스트 커널 공유

 [물리 컴퓨터]
 ┌────────────────────────────┐
 │     Host OS (리눅스)        │  ← 커널 공유
 │  ┌──────────────────────┐  │
 │  │ 컨테이너 런타임       │  │  ← Docker
 │  └───────┬──────────────┘  │
 │     ┌────▼────┐  ┌────▼────┐
 │     │ Container│ │ Container│  ← 가벼운 격리 환경
 │     │  Nginx   │ │  Python  │  ← rootfs + 라이브러리 + 앱
 │     └──────────┘ └──────────┘
 └────────────────────────────┘


가상머신 운용 방법

전체 가상화 : 게스트 os가 가상 하드웨어를 제어하는 것처럼 보이게 함
프로세스 -> 게스트os -> 가상 하드웨어 -> trap -> 하이퍼바이저 -> 실제 하드웨어

반 가상화 : 게스트 os가 하이퍼바이저와 협력하여 수행. virtio 가상화 친화 드라이버 사용.
프로세스 -> 게스트os <-> 하이퍼바이저 -> 실제 하드웨어

하드웨어 가상화 : cpu가 가상화를 하드웨어 수준에서 지원
프로세스 -> 게스트os -> cpu가 직접 실행 또는 trap 시 -> 하이퍼바이저 -> 실제 하드웨어



qemu? 호스트 구조 전체 가상화 하이퍼바이저
kvm? 하드웨어 가상화에서 사용하는 커널 모듈

큰 틀은 qemu를 쓰고 하드웨어 가상화를 추가로 진행하여 qemu+kvm 방식으로 많이 씀.

cpu 권한 레벨
x86에서는 Ring 0 (커널) ~ Ring 3 (유저)
ring 0에서 실행되길 원하지만 호스트 os와 충돌.
ARM에서는 EL0~EL3
EL1에서 실행되길 원하지만 호스트 os와 충돌

따라서
하이퍼바이저가 게스트의 모든 cpu 명령어를 소프트웨어적으로 감지하고 흉내내거나
게스트 os가 ring0에서 실행되도록 허용하되 특권 명령어는 trap 되어 하이퍼바이저(EL2)로 전환되어 처리된다.