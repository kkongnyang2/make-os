
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../3-kernel/">
      
      
        <link rel="next" href="../5-trap/">
      
      
      <link rel="icon" href="../logo.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>4 MMU - Make-OS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../soft-era.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="apple" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#xv6-riscv-vmc" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Make-OS" class="md-header__button md-logo" aria-label="Make-OS" data-md-component="logo">
      
  <img src="../logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Make-OS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              4 MMU
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="apple" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Soft Era"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Soft Era" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20.71 4.63-1.34-1.34c-.37-.39-1.02-.39-1.41 0L9 12.25 11.75 15l8.96-8.96c.39-.39.39-1.04 0-1.41M7 14a3 3 0 0 0-3 3c0 1.31-1.16 2-2 2 .92 1.22 2.5 2 4 2a4 4 0 0 0 4-4 3 3 0 0 0-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="soft" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Apple Classic"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Apple Classic" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20.71 4.63-1.34-1.34c-.37-.39-1.02-.39-1.41 0L9 12.25 11.75 15l8.96-8.96c.39-.39.39-1.04 0-1.41M7 14a3 3 0 0 0-3 3c0 1.31-1.16 2-2 2 .92 1.22 2.5 2 4 2a4 4 0 0 0 4-4 3 3 0 0 0-3-3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../1-vm/" class="md-tabs__link">
        
  
  
    
  
  1 vm

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../10-mini-os/" class="md-tabs__link">
        
  
  
    
  
  10 mini os

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../2-hw/" class="md-tabs__link">
        
  
  
    
  
  2 hw

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../3-kernel/" class="md-tabs__link">
        
  
  
    
  
  3 kernel

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  4 MMU

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../5-trap/" class="md-tabs__link">
        
  
  
    
  
  5 trap

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../6-PCB/" class="md-tabs__link">
        
  
  
    
  
  6 PCB

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../7-uart/" class="md-tabs__link">
        
  
  
    
  
  7 uart

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../8-mkfs/" class="md-tabs__link">
        
  
  
    
  
  8 mkfs

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../9-build/" class="md-tabs__link">
        
  
  
    
  
  9 build

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Make-OS" class="md-nav__button md-logo" aria-label="Make-OS" data-md-component="logo">
      
  <img src="../logo.svg" alt="logo">

    </a>
    Make-OS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../1-vm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 vm
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../10-mini-os/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    10 mini os
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../2-hw/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 hw
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../3-kernel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 kernel
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    4 MMU
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    4 MMU
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#xv6-riscv-vmc" class="md-nav__link">
    <span class="md-ellipsis">
      xv6-riscv의 vm.c 파일을 읽어보자
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xv6-riscv의 vm.c 파일을 읽어보자">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mmu" class="md-nav__link">
    <span class="md-ellipsis">
      목표: MMU 이해
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0" class="md-nav__link">
    <span class="md-ellipsis">
      0&gt; 개념 정리
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1&gt; 용어 정리
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2&gt; 흐름 정리
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-vmc" class="md-nav__link">
    <span class="md-ellipsis">
      3&gt; vm.c
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../5-trap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5 trap
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../6-PCB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    6 PCB
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../7-uart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    7 uart
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../8-mkfs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    8 mkfs
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../9-build/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    9 build
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#xv6-riscv-vmc" class="md-nav__link">
    <span class="md-ellipsis">
      xv6-riscv의 vm.c 파일을 읽어보자
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xv6-riscv의 vm.c 파일을 읽어보자">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mmu" class="md-nav__link">
    <span class="md-ellipsis">
      목표: MMU 이해
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0" class="md-nav__link">
    <span class="md-ellipsis">
      0&gt; 개념 정리
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1&gt; 용어 정리
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2&gt; 흐름 정리
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-vmc" class="md-nav__link">
    <span class="md-ellipsis">
      3&gt; vm.c
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>4 MMU</h1>

<h2 id="xv6-riscv-vmc">xv6-riscv의 vm.c 파일을 읽어보자</h2>
<h3 id="mmu">목표: MMU 이해</h3>
<p>작성자: kkongnyang2 작성일: 2025-06-25</p>
<hr />
<h3 id="0">0&gt; 개념 정리</h3>
<p>페이지? 공간을 연속적으로 할당하지 않고 페이지라는 단위로 쪼개서 사용한다.<br />
프로세스의 메모리도, 실제 physical 메모리도 페이지 4KB 단위로 쪼갠다.</p>
<p>그리고 이러한 VPN(virtual page number)과 PEN(physical frame number)로 매핑해주는 표가 page table이다.(원소는 PTE)<br />
한 프로세스에 대해 page table 절반은 프로세스 PTE, 절반은 공통으로 사용하는 커널 PTE 이다.</p>
<p>그럼 이 페이지 테이블 실체는 어디에 저장되냐? 공통 커널 PTE는 부팅시 .text, .data 밖 kalloc() 동적할당에 존재하고 satp CSR을 통해 부른다. 각 프로세스 PTE는 역시 kalloc() 동적할당에 저장되고, 개별 root PT 주소를 저장한다.</p>
<p>그럼 페이지 테이블에서 각 PTE를 어떻게 찾느냐? VA를 4조각으로 끊어 3개의 index와 page offset으로 사용한다. 이 목차로 페이지 테이블을 구성하기에 한영사전 처럼 찾을수 있는 것이다.</p>
<p>참고로 디스크에서는 블록이라는 단위를 쓰고, inode 메타데이터를 통해 블록끼리 연결된다. 이 디스크의 데이터를 메모리로 올릴 때 xv6은 각 페이지마다 VA 페이지를 할당하고 memcpy한다. </p>
<h3 id="1">1&gt; 용어 정리</h3>
<div class="highlight"><pre><span></span><code>가상주소 (VA, Virtual Address)        // 사용자·커널 코드가 쓰는 논리적 주소
물리주소 (PA, Physical Address)        // 실제 DRAM 칩의 셀 위치
MMU (Memory Management Unit)           // VA→PA 변환을 담당하는 하드웨어
TLB (Translation Look-aside Buffer)    // 변환 결과를 캐시해 속도를 높이는 MMU 내부 캐시
SATP (System Address Translation &amp; Protection) // RISC-V가 현재 사용할 최상위 페이지테이블의 물리주소, 모드, ASID를 담는 CSR
PTE (Page Table Entry)                 // VA 범위 하나와 대응하는 설정(PPN·권한 비트 등)을 담은 64bit 구조체
VPN (Virtual Page Number)              // VA를 페이지 크기(4 KiB)로 나눈 인덱스 3단( Sv39 )/4단( Sv48 )
PPN (Physical Page Number)             // 실제 물리 페이지 프레임 번호
R/W/X 비트                             // Read/Write/Execute 허가 비트
U/S 비트                               // U-mode(유저)/S-mode(커널) 접근 허가
A/D 비트                               // Accessed/Dirty – 페이지 사용·쓰기 발생 시 MMU가 자동 set
sfence.vma zero,zero                   // TLB 전부 무효화(페이지테이블 바꾼 뒤 필수)
csrw satp, t1                          // SATP CSR에 새로운 페이지테이블(root PPN) 등록
</code></pre></div>
<h3 id="2">2&gt; 흐름 정리</h3>
<div class="highlight"><pre><span></span><code>start.c      → kvminit()         → vm.c
              (커널전용)              ├─ kvmmake()      // 커널 자체 map
                                    ├─ kvmmap()       // 실제 page → VA 매핑 헬퍼
                                    ├─ kvminithart()  // CSR·TLB init
                fork(), exec() ↓
                                    ├─ uvminit()      // 유저 초기 page
                                    ├─ uvmalloc()     // 유저 주소공간 성장
                                    └─ walk(), mappages() 등
</code></pre></div>
<div class="highlight"><pre><span></span><code>물리주소
0x8000_0000 ─┬─ .text
             │
             ├─ .rodata
             ├─ .data                  ★ kernel_pagetable 포인터 변수
             ├─ .bss                   (값은 아직 0)
end ─────────┘
             ├─────────── Free RAM managed by kalloc() ────────────┐
             │                                                     │
             │ 0x8010_0000  ── kernel_pagetable (root PT 4 KiB) ◀─┐│
             │ 0x8010_1000  ── per-process A root PT             ││
             │ 0x8010_2000  ── per-process B root PT             ││
             │   ...         ── L1/L0 PT, kernel stacks, buffers ││
             └────────────────────────────────────────────────────┘
0x8800_0000 ─ PHYSTOP  (xv6 가용 RAM 상한)
</code></pre></div>
<p><div class="highlight"><pre><span></span><code> 63             39 38           30 29           21 20           12 11            0
┌────────────────┬──────────────┬──────────────┬──────────────┬────────────────┐
|   sign-extend  |   VPN[2]     |   VPN[1]     |   VPN[0]     | page offset    |
└────────────────┴──────────────┴──────────────┴──────────────┴────────────────┘
   (25 bits)        (9 bits)       (9 bits)       (9 bits)         (12 bits)
</code></pre></div><br />
페이지 크기 4KB -&gt; offset 12bit<br />
레벨 수 3단계. root PTE -&gt; 중간 -&gt; leaf</p>
<p><div class="highlight"><pre><span></span><code>root PT (9 bits)
┌─────0         255─────┬────256        511────┐
│   user area entries   │  kernel area entries │
│ (각 프로세스마다 달라) │ (모든 프로세스가 동일)│
└───────────────────────┴──────────────────────┘
</code></pre></div><br />
root의 아래 영역까지 합치면 38비트는 user area, 38비트는 kernel area이다.</p>
<p><div class="highlight"><pre><span></span><code> 63          10 9    8 7 6 5 4 3 2 1 0
┌─────────────┬──────┬───────────────┐
|  PPN[2:0]   | RSVD |  D A G U X W R|
└─────────────┴──────┴───────────────┘
   44 bits      2      권한·상태 비트
</code></pre></div><br />
PTE 형식(64bit=8byte) </p>
<h3 id="3-vmc">3&gt; vm.c</h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;param.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;types.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;memlayout.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;elf.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;riscv.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;defs.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;fs.h&quot;</span>

<span class="c1">// pagetable_t : 하나당 8byte인 PTE 512개를 담은 테이블 한 페이지를 가리키는 타입.</span>
<span class="c1">// 커널 루트 페이지테이블 명명</span>
<span class="n">pagetable_t</span><span class="w"> </span><span class="n">kernel_pagetable</span><span class="p">;</span>

<span class="k">extern</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">etext</span><span class="p">[];</span><span class="w">  </span><span class="c1">// kernel.ld에서 .text 끝나는 표시</span>

<span class="k">extern</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">trampoline</span><span class="p">[];</span>

<span class="c1">// 커널 테이블 생성</span>
<span class="n">pagetable_t</span>
<span class="nf">kvmmake</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">kpgtbl</span><span class="p">;</span>

<span class="w">  </span><span class="n">kpgtbl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="w"> </span><span class="n">kalloc</span><span class="p">();</span><span class="w">      </span><span class="c1">// 페이지 하나 할당</span>
<span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span><span class="w">            </span><span class="c1">// PTE 512개 모두 0으로 초기화 </span>

<span class="w">  </span><span class="c1">// MMIO 영역들 PTE 만들기. 읽기/쓰기 허용</span>
<span class="w">  </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">UART0</span><span class="p">,</span><span class="w"> </span><span class="n">UART0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">);</span>
<span class="w">  </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">VIRTIO0</span><span class="p">,</span><span class="w"> </span><span class="n">VIRTIO0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">);</span>
<span class="w">  </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">PLIC</span><span class="p">,</span><span class="w"> </span><span class="n">PLIC</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4000000</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 커널 .text 영역들 PTE 만들기. 읽기/실행 허용</span>
<span class="w">  </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">KERNBASE</span><span class="p">,</span><span class="w"> </span><span class="n">KERNBASE</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">etext</span><span class="o">-</span><span class="n">KERNBASE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_X</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 커널 .data 영역들 PTE 만들기. 읽기/쓰기 허용</span>
<span class="w">  </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">etext</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">etext</span><span class="p">,</span><span class="w"> </span><span class="n">PHYSTOP</span><span class="o">-</span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">etext</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 커널 .trampoline 영역들 PTE 만들기.(최고 VA) 읽기/실행 허용</span>
<span class="w">  </span><span class="n">kvmmap</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">TRAMPOLINE</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">trampoline</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_X</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 각 프로세스용 커널 스택 2페이지 영역을 예약 및 매핑</span>
<span class="w">  </span><span class="n">proc_mapstacks</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">kpgtbl</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 부팅시 hart0에서 단 한번 커널 테이블 initialize</span>
<span class="kt">void</span>
<span class="nf">kvminit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">kernel_pagetable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kvmmake</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// 부팅시 각 하트마다 단 한번 커널 테이블 initialize.</span>
<span class="kt">void</span>
<span class="nf">kvminithart</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">sfence_vma</span><span class="p">();</span><span class="w">                 </span><span class="c1">// 펜스</span>

<span class="w">  </span><span class="n">w_satp</span><span class="p">(</span><span class="n">MAKE_SATP</span><span class="p">(</span><span class="n">kernel_pagetable</span><span class="p">));</span><span class="w">  </span><span class="c1">// satp CSR에 kernel_pagetable 적용</span>

<span class="w">  </span><span class="n">sfence_vma</span><span class="p">();</span><span class="w">                 </span><span class="c1">// TLB 캐시 무효화</span>
<span class="p">}</span>

<span class="c1">// PTE 찾기 or 생성(alloc에 따라)</span>
<span class="n">pte_t</span><span class="w"> </span><span class="o">*</span>
<span class="nf">walk</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">alloc</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">va</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAXVA</span><span class="p">)</span><span class="w">               </span><span class="c1">// 유저 범위(38bit) 초과 접근은 즉시 패닉</span>
<span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;walk&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">level</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">      </span><span class="c1">// L2,L1까지 탐색</span>
<span class="w">    </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pagetable</span><span class="p">[</span><span class="n">PX</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">)];</span><span class="w">     </span><span class="c1">// va에서 해당 레벨 9bit 추출해서 페이지테이블에서 그 인덱스 pte 가져오기</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">                          </span><span class="c1">// valid(존재)하면</span>
<span class="w">      </span><span class="n">pagetable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">PTE2PA</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">);</span><span class="w">    </span><span class="c1">// 하위 PT 물리주소 반환</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">                                    </span><span class="c1">// 없으면</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">alloc</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pde_t</span><span class="o">*</span><span class="p">)</span><span class="n">kalloc</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// alloc도 안켜졋으면</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">                               </span><span class="c1">// 실패</span>
<span class="w">      </span><span class="n">memset</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span><span class="w">             </span><span class="c1">// 새 하위 PT set</span>
<span class="w">      </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PA2PTE</span><span class="p">(</span><span class="n">pagetable</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">;</span><span class="w">         </span><span class="c1">// 상위 PTE에 기록(V=1)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pagetable</span><span class="p">[</span><span class="n">PX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">)];</span><span class="w">                 </span><span class="c1">// L0 인덱스랑 똑같은 leaf PTE 물리주소 반환</span>
<span class="p">}</span>

<span class="c1">// PPN 추출</span>
<span class="n">uint64</span>
<span class="nf">walkaddr</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="p">;</span>
<span class="w">  </span><span class="n">uint64</span><span class="w"> </span><span class="n">pa</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">va</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAXVA</span><span class="p">)</span><span class="w">       </span><span class="c1">// 유저 범위(38bit) 초과시 거부</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">walk</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">       </span><span class="c1">// leaf PTE 찾기</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pte</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">                        </span><span class="c1">// 존재안하면 실패</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">             </span><span class="c1">// valid 안하면 실패</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_U</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">             </span><span class="c1">// U 모드 아니면 실패</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTE2PA</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">);</span><span class="w">                  </span><span class="c1">// PPN 추출</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">pa</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 커널 전용(kvmmake에서만 호출)</span>
<span class="kt">void</span>
<span class="nf">kvmmap</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">sz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// mappages가 0을 리턴하면 PT 만들기에 성공한 것. 실패하면 패닉</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">mappages</span><span class="p">(</span><span class="n">kpgtbl</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">,</span><span class="w"> </span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;kvmmap&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 테이블 만들기</span>
<span class="kt">int</span>
<span class="nf">mappages</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">uint64</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="p">;</span>
<span class="w">  </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">va</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">          </span><span class="c1">// 페이지당 첫 VA(page offset=0)만 PTE 만들어줌</span>
<span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;mappages: va not aligned&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">size</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">        </span><span class="c1">// 만들 테이블 크기도 4KB 단위로</span>
<span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;mappages: size not aligned&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">               </span><span class="c1">// 길이 0은 의미가 없음</span>
<span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;mappages: size&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">va</span><span class="p">;</span><span class="w">                       </span><span class="c1">// 현재 VA</span>
<span class="w">  </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span><span class="w">    </span><span class="c1">// 마지막 VA</span>
<span class="w">  </span><span class="k">for</span><span class="p">(;;){</span>
<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">walk</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">    </span><span class="c1">// leaf PTE 생성</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w">                              </span><span class="c1">// 실패시 -1</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">)</span><span class="w">                          </span><span class="c1">// 이미 valid하면 오류</span>
<span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;mappages: remap&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PA2PTE</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">;</span><span class="w">         </span><span class="c1">// PTE 내용 (PPN과 권한비트) 세팅</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">last</span><span class="p">)</span><span class="w">                             </span><span class="c1">// last면 break</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span><span class="w">                              </span><span class="c1">// 아직 안끝났으면 다음 페이지</span>
<span class="w">    </span><span class="n">pa</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// PTE 무효화 및 해당 PA free</span>
<span class="kt">void</span>
<span class="nf">uvmunmap</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">npages</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">do_free</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">uint64</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">  </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">va</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;uvmunmap: not aligned&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">va</span><span class="p">;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">npages</span><span class="o">*</span><span class="n">PGSIZE</span><span class="p">;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">){</span>
<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">walk</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">          </span><span class="c1">// leaf PTE 찾기</span>
<span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;uvmunmap: walk&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">                         </span><span class="c1">// valid 없으면 오류</span>
<span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;uvmunmap: not mapped&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">PTE_FLAGS</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">)</span><span class="w">                    </span><span class="c1">// leaf가 아니면 오류</span>
<span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;uvmunmap: not a leaf&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">do_free</span><span class="p">){</span><span class="w">                                    </span><span class="c1">// 해당 PA free</span>
<span class="w">      </span><span class="n">uint64</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTE2PA</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">);</span>
<span class="w">      </span><span class="n">kfree</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">pa</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">                                       </span><span class="c1">// PTE 무효화</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 빈 사용자 테이블 만들기</span>
<span class="n">pagetable_t</span>
<span class="nf">uvmcreate</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="p">;</span>
<span class="w">  </span><span class="n">pagetable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="w"> </span><span class="n">kalloc</span><span class="p">();</span><span class="w">     </span><span class="c1">// 4KB 페이지 한장 -&gt; root PT</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pagetable</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">            </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span><span class="w">           </span><span class="c1">// 512개 PTE 전부 0으로 초기화</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">pagetable</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// initcode 물리 공간 할당하고 테이블(앞쪽 유저 프로세스)도 만들기</span>
<span class="c1">// 커널은 파일 시스템을 초기화할때까지 S모드이지만 이 PT는 U모드 전용으로 쓸 수 있게</span>
<span class="kt">void</span>
<span class="nf">uvmfirst</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">uchar</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">mem</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">sz</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">)</span><span class="w">                        </span><span class="c1">// initcode 크기(주소 범위) 검사</span>
<span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;uvmfirst: more than a page&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kalloc</span><span class="p">();</span><span class="w">                         </span><span class="c1">// 물리 공간 mem 4KB만큼 할당</span>
<span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span><span class="w">                 </span><span class="c1">// 전부 0으로 초기화</span>
<span class="w">  </span><span class="c1">// 0x00000000(VA) 과 mem(물리) 매핑하는 테이블 만들기</span>
<span class="w">  </span><span class="c1">// WRX 허용하고 U 모드도 접근 가능하게</span>
<span class="w">  </span><span class="n">mappages</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">mem</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_W</span><span class="o">|</span><span class="n">PTE_R</span><span class="o">|</span><span class="n">PTE_X</span><span class="o">|</span><span class="n">PTE_U</span><span class="p">);</span>
<span class="w">  </span><span class="n">memmove</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">);</span><span class="w">                </span><span class="c1">// 가지고 있던 initcode 바이트를 해당 물리페이지로 복사</span>
<span class="p">}</span>

<span class="c1">// 주소 확장</span>
<span class="n">uint64</span>
<span class="nf">uvmalloc</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">oldsz</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">newsz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">xperm</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">mem</span><span class="p">;</span>
<span class="w">  </span><span class="n">uint64</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">newsz</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">oldsz</span><span class="p">)</span><span class="w">               </span><span class="c1">// 이전보다 작아진 요청? -&gt; 그대로 둠</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">oldsz</span><span class="p">;</span>

<span class="w">  </span><span class="n">oldsz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGROUNDUP</span><span class="p">(</span><span class="n">oldsz</span><span class="p">);</span><span class="w">       </span><span class="c1">// 시작점을 페이지 경계로 올림</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldsz</span><span class="p">;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">newsz</span><span class="p">;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">){</span><span class="w">   </span><span class="c1">// 한 페이지씩 전진</span>
<span class="w">    </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kalloc</span><span class="p">();</span><span class="w">                         </span><span class="c1">// 물리 공간 할당</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mem</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span><span class="w">                           </span><span class="c1">// 실패 -&gt; 롤백</span>
<span class="w">      </span><span class="n">uvmdealloc</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">oldsz</span><span class="p">);</span><span class="w">      </span><span class="c1">// 정리 후 0 반환</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span><span class="w">                 </span><span class="c1">// 공간 0으로 초기화</span>
<span class="w">    </span><span class="c1">// 매핑 실패시</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mappages</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">mem</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_R</span><span class="o">|</span><span class="n">PTE_U</span><span class="o">|</span><span class="n">xperm</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">      </span><span class="n">kfree</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span><span class="w">                           </span><span class="c1">// 공간 반납</span>
<span class="w">      </span><span class="n">uvmdealloc</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">oldsz</span><span class="p">);</span><span class="w">      </span><span class="c1">// 다시 oldsz로 테이블 롤백</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">newsz</span><span class="p">;</span><span class="w">                             </span><span class="c1">// 매핑 성공시 새 sz</span>
<span class="p">}</span>

<span class="c1">// 주소 축소</span>
<span class="n">uint64</span>
<span class="nf">uvmdealloc</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">oldsz</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">newsz</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">newsz</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">oldsz</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">oldsz</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// PTE 무효화 및 해당 PA free</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">PGROUNDUP</span><span class="p">(</span><span class="n">newsz</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PGROUNDUP</span><span class="p">(</span><span class="n">oldsz</span><span class="p">)){</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">npages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PGROUNDUP</span><span class="p">(</span><span class="n">oldsz</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">PGROUNDUP</span><span class="p">(</span><span class="n">newsz</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
<span class="w">    </span><span class="n">uvmunmap</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">PGROUNDUP</span><span class="p">(</span><span class="n">newsz</span><span class="p">),</span><span class="w"> </span><span class="n">npages</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">newsz</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// tree 자체를 재귀적 free</span>
<span class="kt">void</span>
<span class="nf">freewalk</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// there are 2^9 = 512 PTEs in a page table.</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">512</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<span class="w">    </span><span class="n">pte_t</span><span class="w"> </span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pagetable</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">PTE_R</span><span class="o">|</span><span class="n">PTE_W</span><span class="o">|</span><span class="n">PTE_X</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">      </span><span class="c1">// this PTE points to a lower-level page table.</span>
<span class="w">      </span><span class="n">uint64</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTE2PA</span><span class="p">(</span><span class="n">pte</span><span class="p">);</span>
<span class="w">      </span><span class="n">freewalk</span><span class="p">((</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">child</span><span class="p">);</span>
<span class="w">      </span><span class="n">pagetable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">){</span>
<span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;freewalk: leaf&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">kfree</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">pagetable</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 사용자 공간 전체 free(PTE + PA + 트리)</span>
<span class="kt">void</span>
<span class="nf">uvmfree</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">sz</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">uvmunmap</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGROUNDUP</span><span class="p">(</span><span class="n">sz</span><span class="p">)</span><span class="o">/</span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">freewalk</span><span class="p">(</span><span class="n">pagetable</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Given a parent process&#39;s page table, copy</span>
<span class="c1">// its memory into a child&#39;s page table.</span>
<span class="c1">// Copies both the page table and the</span>
<span class="c1">// physical memory.</span>
<span class="c1">// returns 0 on success, -1 on failure.</span>
<span class="c1">// frees any allocated pages on failure.</span>
<span class="kt">int</span>
<span class="nf">uvmcopy</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">new</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="p">;</span>
<span class="w">  </span><span class="n">uint64</span><span class="w"> </span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">  </span><span class="n">uint</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">mem</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sz</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">){</span>
<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">walk</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;uvmcopy: pte should exist&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;uvmcopy: page not present&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTE2PA</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">);</span>
<span class="w">    </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTE_FLAGS</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kalloc</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">    </span><span class="n">memmove</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mappages</span><span class="p">(</span><span class="n">new</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">mem</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">      </span><span class="n">kfree</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w"> </span><span class="nl">err</span><span class="p">:</span>
<span class="w">  </span><span class="n">uvmunmap</span><span class="p">(</span><span class="n">new</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// mark a PTE invalid for user access.</span>
<span class="c1">// used by exec for the user stack guard page.</span>
<span class="kt">void</span>
<span class="nf">uvmclear</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">va</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="p">;</span>

<span class="w">  </span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">walk</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pte</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;uvmclear&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">PTE_U</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Copy from kernel to user.</span>
<span class="c1">// Copy len bytes from src to virtual address dstva in a given page table.</span>
<span class="c1">// Return 0 on success, -1 on error.</span>
<span class="kt">int</span>
<span class="nf">copyout</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">dstva</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">uint64</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">va0</span><span class="p">,</span><span class="w"> </span><span class="n">pa0</span><span class="p">;</span>
<span class="w">  </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="p">;</span>

<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">    </span><span class="n">va0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGROUNDDOWN</span><span class="p">(</span><span class="n">dstva</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">va0</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAXVA</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">walk</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">va0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">pte</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_V</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_U</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">       </span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="n">pa0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTE2PA</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">);</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">dstva</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">va0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="w">      </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="w">    </span><span class="n">memmove</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">pa0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">dstva</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">va0</span><span class="p">)),</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>

<span class="w">    </span><span class="n">len</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">    </span><span class="n">src</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">    </span><span class="n">dstva</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">va0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Copy from user to kernel.</span>
<span class="c1">// Copy len bytes to dst from virtual address srcva in a given page table.</span>
<span class="c1">// Return 0 on success, -1 on error.</span>
<span class="kt">int</span>
<span class="nf">copyin</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">srcva</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">uint64</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">va0</span><span class="p">,</span><span class="w"> </span><span class="n">pa0</span><span class="p">;</span>

<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">    </span><span class="n">va0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGROUNDDOWN</span><span class="p">(</span><span class="n">srcva</span><span class="p">);</span>
<span class="w">    </span><span class="n">pa0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">walkaddr</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">va0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">pa0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">srcva</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">va0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="w">      </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="w">    </span><span class="n">memmove</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">pa0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">srcva</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">va0</span><span class="p">)),</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>

<span class="w">    </span><span class="n">len</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">    </span><span class="n">dst</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">    </span><span class="n">srcva</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">va0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Copy a null-terminated string from user to kernel.</span>
<span class="c1">// Copy bytes to dst from virtual address srcva in a given page table,</span>
<span class="c1">// until a &#39;\0&#39;, or max.</span>
<span class="c1">// Return 0 on success, -1 on error.</span>
<span class="kt">int</span>
<span class="nf">copyinstr</span><span class="p">(</span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">srcva</span><span class="p">,</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">uint64</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">va0</span><span class="p">,</span><span class="w"> </span><span class="n">pa0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">got_null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="n">got_null</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">    </span><span class="n">va0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGROUNDDOWN</span><span class="p">(</span><span class="n">srcva</span><span class="p">);</span>
<span class="w">    </span><span class="n">pa0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">walkaddr</span><span class="p">(</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">va0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">pa0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">srcva</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">va0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max</span><span class="p">)</span>
<span class="w">      </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">;</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">pa0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">srcva</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">va0</span><span class="p">));</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">){</span>
<span class="w">        </span><span class="o">*</span><span class="n">dst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="n">got_null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">dst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="o">--</span><span class="n">n</span><span class="p">;</span>
<span class="w">      </span><span class="o">--</span><span class="n">max</span><span class="p">;</span>
<span class="w">      </span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="n">dst</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">srcva</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">va0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">got_null</span><span class="p">){</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "content.code.copy", "header.autohide"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>