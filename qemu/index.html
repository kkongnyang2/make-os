
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>이론 - make-os</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="make-os" class="md-header__button md-logo" aria-label="make-os" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            make-os
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              이론
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="make-os" class="md-nav__button md-logo" aria-label="make-os" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    make-os
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    이론
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    이론
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; 설치
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; 만들 구조
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; 모듈 설명
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; 주소
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arm64" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; arm64 특성
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#qemu" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; qemu 테스트
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#makefile" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; Makefile
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; 디버깅
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uart" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; Uart
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mmu" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; mmu(메모리 매니지먼트 유닛)
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; 설치
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; 만들 구조
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; 모듈 설명
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; 주소
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arm64" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; arm64 특성
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#qemu" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; qemu 테스트
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#makefile" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; Makefile
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; 디버깅
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#uart" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; Uart
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mmu" class="md-nav__link">
    <span class="md-ellipsis">
      &gt; mmu(메모리 매니지먼트 유닛)
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>이론</h1>

<p>✅ 최종 정리</p>
<p>✔️ 목표: Bare-metal에서 하드웨어 제어<br />
✔️ 테스트 환경: QEMU ARM64 Virt Machine (LED 대신 UART 출력)<br />
✔️ 방법: Bare-metal → UART → Timer → MMU → Shell<br />
✔️ 기존 예제 코드 참고해서 복붙, 주석 추가로 구조 이해<br />
✔️ 결국 Buildroot 수준까지 목표 → rootfs 만들어 BusyBox, 네트워크 추가</p>
<h3 id="_1">&gt; 설치<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>~$ sudo apt install qemu-system-aarch64         #qemu arm64 설치
~$ qemu-system-aarch64 --version                #설치 확인
QEMU emulator version 6.2.0 (Debian 1:6.2+dfsg-2ubuntu6.26)

~$ sudo apt install gcc-aarch64-linux-gnu       #크로스컴파일러 설치   
~$ aarch64-linux-gnu-gcc --version              #설치 확인
aarch64-linux-gnu-gcc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0
</code></pre></div>
<h3 id="_2">&gt; 만들 구조<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>baremetal/<br />
├── Makefile<br />
├── link.ld<br />
├── start.S               # 부트 코드(초기화)<br />
├── include/              # 헤더파일<br />
│   ├── uart.h            # UART 헤더<br />
│   ├── timer.h           # Timer 헤더<br />
│   └── mmu.h             # MMU 헤더<br />
├── drivers/              # 하드웨어 드라이버 모음<br />
│   ├── uart.c<br />
│   ├── timer.c<br />
│   └── mmu.c<br />
├── kernel/               # 커널 로직<br />
│   ├── main.c            # 진입점, 초기화 순서<br />
│   ├── shell.c          # Shell<br />
│   └── scheduler.c     # (나중에 추가)<br />
└── build/                # 빌드 산출물<br />
    ├── kernel.elf<br />
    └── kernel.img</p>
<h3 id="_3">&gt; 모듈 설명<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>UART : 직접 레지스터에 값 쓰기 → 출력<br />
Timer : 인터럽트 → tick 발생<br />
MMU : 페이지 테이블 → 주소 변환<br />
Shell : UART I/O로 기본 명령어 인터프리터</p>
<h3 id="_4">&gt; 주소<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>qemu virt machine 기준</p>
<p>0x09000000: UART0 (직렬 통신 장치. 컴퓨터와 터미널 간 텍스트 주고받을 때 사용)<br />
0x08000000: GIC (인터럽트 관리 컨트롤러. timer, uart, virtio 등 하드웨어 인터렙트를 gic가 받아서 cpu에 전달)<br />
0x0A000000: Virtio (가상화 디바이스 인터페이스. 네트워크, 블록 디바이스 등)<br />
0x40000000: DRAM 시작 주소. 여기부터 메모리<br />
그 사이: bootloader, MMU, DTB 로드<br />
0x40080000: OS/커널 이미지 로딩 주소. 코드(.text)<br />
그 뒤로 데이터,</p>
<p>[ 프로그램의 메모리 공간 ]<br />
┌───────────────┐<br />
│ 벡터 테이블     │  ← 인터럽트 처리 함수 포인터들<br />
├───────────────┤<br />
│ 코드 (.text)   │  ← 실행 명령어(펌웨어, 커널, 앱)<br />
├───────────────┤<br />
│ 상수 (.rodata) │  ← 상수 문자열, 테이블<br />
├───────────────┤<br />
│ 데이터 (.data) │  ← 전역 변수 (초기값 있음)<br />
├───────────────┤<br />
│ BSS (.bss)    │  ← 전역 변수 (초기값 0)<br />
├───────────────┤<br />
│ 힙 (heap)     │  ← malloc, new 등 동적할당<br />
├───────────────┤<br />
│ 스택 (stack)   │  ← 함수 호출, 지역 변수<br />
└───────────────┘</p>
<div class="highlight"><pre><span></span><code>~$ cat &gt; link.ld                      #link.ld 생성
SECTIONS
{
    . = 0x40080000; /* QEMU virt machine에서 기본 로드주소 */
    .text : { *(.text*) }
    .rodata : { *(.rodata*) }
    .data : { *(.data*) }
    .bss : { *(.bss*) }
}
Ctrl+D
</code></pre></div>
<h3 id="arm64">&gt; arm64 특성<a class="headerlink" href="#arm64" title="Permanent link">&para;</a></h3>
<ol>
<li>바이트 순서: little endian사용. 0x12345678은 메모리에 78 56 34 12 순서로 저장.</li>
<li>메모리 정렬: 4바이트 단위의 word alignment가 기본. 0x40080001같은건 정렬되지 않은 주소.</li>
<li>레지스터: x0 ~ x30은 범용 레지스터, sp는 스택 포인터, pc는 프로그램 카운터, VBAR_EL1은 인터럽트 벡터 베이스, TTBR_EL1은 페이지 테이블 베이스, SCTLR_EL1은 시스템 제어 레지스터(MMU,캐시 켜기)</li>
<li>함수 호출 규약: 리턴값은 x0, 파라메터 x0~x7. 스택은 16바이트 정렬(align 16)</li>
</ol>
<hr />
<h3 id="qemu">&gt; qemu 테스트<a class="headerlink" href="#qemu" title="Permanent link">&para;</a></h3>
<p>[ hello.S ] --(어셈블러)--&gt; [ hello.o ] --(링커)--&gt; [ kernel.elf ] --(objcopy)--&gt; [ kernel.img ]<br />
어셈블리 → 오브젝트 : CPU가 이해할 수 있는 기계어(.o)로 변환<br />
오브젝트 → ELF 실행파일 : 코드와 데이터(섹션)들을 주소에 맞게 배치<br />
ELF → 바이너리 이미지 : ELF 헤더 제거, 부트로더/에뮬레이터가 바로 읽을 수 있게</p>
<div class="highlight"><pre><span></span><code>~$ cat &gt; test.S                      #test.S 생성
.section .text
.globl _start
_start:

    b .
Ctrl+D
</code></pre></div>
<div class="highlight"><pre><span></span><code>~$ aarch64-linux-gnu-as hello.S -o hello.o                      #어셈블리&gt;오브젝트
~$ aarch64-linux-gnu-ld -T link.ld hello.o -o kernel.elf        #링커
~$ aarch64-linux-gnu-objcopy -O binary kernel.elf kernel.img    #바이너리로 변환

~$ qemu-system-aarch64 \
    -M virt \                                                   #표준 ARM64 가상머신
    -cpu cortex-a53 \                                           #ARM64 CPU
    -nographic \                                                #시리얼로만 입출력
    -kernel kernel8.img                                         #커널 바이너리 지정
Ctrl+A X
</code></pre></div>
<div class="highlight"><pre><span></span><code>~$ ps aux | grep qemu           #실행중인 프로세스 번호
~$ kill 숫자                     #강제종료
</code></pre></div>
<hr />
<h3 id="makefile">&gt; Makefile<a class="headerlink" href="#makefile" title="Permanent link">&para;</a></h3>
<p>위 과정을 하나로 정리</p>
<h3 id="_5">&gt; 디버깅<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>다른 터미널에서<br />
gdb-multiarch ~/make-os/kernel.elf<br />
(gdb) target remote localhost:1234  #연결<br />
(gdb) continue                      #코드 실행<br />
(gdb) quit                          #그만두면 멈춘 주소 나타남<br />
(gdb) info registers                #레지스터 정보<br />
(gdb) disassemble                   #어셈블리 코드 보기<br />
(gdb) x/i $pc                       #현재 위치(pc)</p>
<h3 id="uart">&gt; Uart<a class="headerlink" href="#uart" title="Permanent link">&para;</a></h3>
<ol>
<li>전원 On → 커널 코드 실행</li>
<li>UART로 "Hello" 같은 문자 출력</li>
<li>Timer를 설정해서 "1초마다 인터럽트(IRQ) 주세요"라고 요청</li>
<li>진짜 1초마다 CPU한테 인터럽트가 오면 → 우리가 만든 함수(IRQ 핸들러) 호출됨</li>
<li>거기서 UART로 "Tick!" 출력</li>
</ol>
<p>✅ 전체 흐름 요약: Tick 출력이 나오기까지</p>
<p>🧱 0. QEMU 실행<br />
<div class="highlight"><pre><span></span><code>qemu-system-aarch64<span class="w"> </span>-M<span class="w"> </span>virt<span class="w"> </span>-cpu<span class="w"> </span>cortex-a53<span class="w"> </span>-nographic<span class="w"> </span>-kernel<span class="w"> </span>kernel.img
</code></pre></div><br />
- QEMU는 커널 바이너리를 <code>0x40080000</code>에 로드하고,<br />
- <code>_start</code>라는 심볼(시작 주소)부터 실행을 시작함.</p>
<p>🔥 1. <code>_start</code> 실행 (start.S)</p>
<table>
<thead>
<tr>
<th>동작</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sp</code> 설정</td>
<td>스택 초기화 (<code>_stack_top</code>을 <code>sp</code>로 설정)</td>
</tr>
<tr>
<td><code>VBAR_EL1 = vector_table</code></td>
<td>인터럽트 벡터 테이블 주소 등록</td>
</tr>
<tr>
<td><code>DAIFClr, #0xf</code></td>
<td>모든 인터럽트 허용 (IRQ, FIQ, SError 등)</td>
</tr>
<tr>
<td><code>bl main</code></td>
<td>C 코드 진입점 <code>main()</code> 호출</td>
</tr>
</tbody>
</table>
<p>⚙️ 2. <code>main()</code> 진입 (main.c)<br />
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">uart_puts</span><span class="p">(</span><span class="s">&quot;Starting Timer...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">gic_init</span><span class="p">();</span><span class="w">   </span><span class="c1">// GIC 인터럽트 컨트롤러 초기화</span>
<span class="w">    </span><span class="n">timer_init</span><span class="p">();</span><span class="w"> </span><span class="c1">// 1초 뒤 IRQ 30 인터럽트 설정</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">  </span><span class="c1">// 무한 대기 (인터럽트만 처리함)</span>
<span class="p">}</span>
</code></pre></div></p>
<p>🛠️ 3. GIC 초기화 (gic.c)</p>
<table>
<thead>
<tr>
<th>동작</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GICD_CTLR = 1</code></td>
<td>Distributor 켬 (전역 인터럽트 관리자)</td>
</tr>
<tr>
<td><code>GICC_CTLR = 1</code></td>
<td>CPU Interface 켬 (CPU로 인터럽트 전달 허용)</td>
</tr>
<tr>
<td><code>GICD_ISENABLER0 |= (1 &lt;&lt; 30)</code></td>
<td>IRQ ID 30 (타이머 인터럽트)만 허용</td>
</tr>
</tbody>
</table>
<p>⏱️ 4. Timer 초기화 (timer.c)</p>
<table>
<thead>
<tr>
<th>동작</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cntfrq_el0</code> 읽기</td>
<td>타이머 주파수 (ex. 62.5MHz)</td>
</tr>
<tr>
<td><code>cntp_tval_el0 = cntfrq</code></td>
<td>1초 후 인터럽트 발생 예약</td>
</tr>
<tr>
<td><code>cntp_ctl_el0 = 1</code></td>
<td>타이머 시작 (IRQ 발생 가능)</td>
</tr>
</tbody>
</table>
<p>💤 5. 메인 루프 진입<br />
- <code>main()</code>은 <code>while(1)</code> 루프에 진입하여 아무 일도 하지 않음<br />
- 이후의 동작은 <strong>인터럽트에 의해서만</strong> 발생함</p>
<p>⚡ 6. 1초 후 타이머 인터럽트 발생<br />
- 타이머 내부적으로 <code>cntp_tval_el0</code>에서 카운트 감소<br />
- 0에 도달하면 <strong>IRQ 30번 발생</strong><br />
- CPU는 벡터 테이블을 따라 <strong><code>irq_handler</code> 실행</strong></p>
<p>🧭 7. 벡터 테이블 진입 (start.S)<br />
<div class="highlight"><pre><span></span><code><span class="nl">vector_table:</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">sync_handler</span><span class="w">       </span><span class="c1">// Synchronous Exception</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">irq_handler</span><span class="w">        </span><span class="c1">// IRQ 발생 시 여기가 실행됨</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">fiq_handler</span><span class="w">        </span><span class="c1">// FIQ</span>
<span class="w">    </span><span class="nf">b</span><span class="w"> </span><span class="no">error_handler</span><span class="w">      </span><span class="c1">// SError</span>

<span class="nl">irq_handler:</span>
<span class="w">    </span><span class="nf">bl</span><span class="w"> </span><span class="no">irq_handler_c</span><span class="w">     </span><span class="c1">// 실제 C 핸들러 호출</span>
<span class="w">    </span><span class="nf">eret</span><span class="w">                 </span><span class="c1">// 복귀</span>
</code></pre></div></p>
<p>📦 8. <code>irq_handler_c()</code> 실행 (main.c)<br />
<div class="highlight"><pre><span></span><code><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">intid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gic_acknowledge</span><span class="p">();</span><span class="w">  </span><span class="c1">// IRQ ID 읽기</span>

<span class="n">uart_puts</span><span class="p">(</span><span class="s">&quot;IRQ ID: &quot;</span><span class="p">);</span>
<span class="n">print_dec</span><span class="p">(</span><span class="n">intid</span><span class="p">);</span><span class="w">                        </span><span class="c1">// &quot;IRQ ID: 30&quot; 출력</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">uart_puts</span><span class="p">(</span><span class="s">&quot;Tick!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w">               </span><span class="c1">// &quot;Tick!&quot; 출력</span>
<span class="w">    </span><span class="n">timer_init</span><span class="p">();</span><span class="w">                        </span><span class="c1">// 다시 타이머 재설정 (1초 후 반복)</span>
<span class="p">}</span>

<span class="n">gic_eoi</span><span class="p">(</span><span class="n">intid</span><span class="p">);</span><span class="w">                          </span><span class="c1">// GIC에 처리 완료 알림</span>
</code></pre></div></p>
<p>🔁 9. 루프 반복<br />
- 다시 타이머 설정됨 (<code>timer_init()</code> 호출)<br />
- 또 1초 뒤 IRQ 30 발생 → 위 과정 반복</p>
<p>.section .text<br />
.global _start</p>
<p>_start:<br />
    // 벡터 테이블 등록<br />
    ldr x0, =vector_table<br />
    msr VBAR_EL1, x0<br />
    isb</p>
<div class="highlight"><pre><span></span><code>// GIC 초기화
bl gic_init

// CNTV Timer 설정 (1초)
ldr x1, =0x3B9ACA00      // 1,000,000,000 ticks
msr cntv_tval_el0, x1
mov x2, #1
msr cntv_ctl_el0, x2

// IRQ 언마스크
msr DAIFClr, #2
</code></pre></div>
<p>1:  wfe<br />
    b 1b</p>
<p>.align 11<br />
vector_table:<br />
    // Synchronous EL1t<br />
    b default_handler<br />
    .space 0x80 - 4</p>
<div class="highlight"><pre><span></span><code>// IRQ EL1t
b default_handler
.space 0x80 - 4

// FIQ EL1t
b default_handler
.space 0x80 - 4

// SError EL1t
b default_handler
.space 0x80 - 4

// Synchronous EL1h
b default_handler
.space 0x80 - 4

// IRQ EL1h
b irq_handler
.space 0x80 - 4

// FIQ EL1h
b default_handler
.space 0x80 - 4

// SError EL1h
b default_handler
.space 0x80 - 4
</code></pre></div>
<p>default_handler:<br />
    b .</p>
<p>irq_handler:<br />
    // 메시지 출력<br />
    ldr x0, =tick_msg<br />
print_loop:<br />
    ldrb w1, [x0], #1<br />
    cbz w1, tick_done<br />
    bl putc<br />
    b print_loop</p>
<p>tick_done:<br />
    // 타이머 재설정<br />
    ldr x1, =0x3B9ACA00<br />
    msr cntv_tval_el0, x1</p>
<div class="highlight"><pre><span></span><code>// 인터럽트 EOI 처리
ldr x0, =0x08010010
mov w1, #27            // Timer IRQ ID 27
str w1, [x0]

eret
</code></pre></div>
<p>putc:<br />
    ldr x2, =0x09000000    // UART MMIO<br />
wait_uart:<br />
    ldr w3, [x2, #0x18]<br />
    tst w3, #0x20<br />
    b.ne wait_uart<br />
    str w1, [x2]<br />
    ret</p>
<p>gic_init:<br />
    ldr x0, =0x08000000    // GIC Distributor<br />
    mov w1, #1<br />
    str w1, [x0]           // GICD_CTLR</p>
<div class="highlight"><pre><span></span><code>add x1, x0, #0x100     // GICD_ISENABLER0
mov w2, #(1 &lt;&lt; 27)     // Timer IRQ ID 27
str w2, [x1]

ldr x0, =0x08010000    // GICC base
mov w1, #1
str w1, [x0]           // GICC_CTLR

add x1, x0, #0x4       // GICC_PMR
mov w2, #0xFF
str w2, [x1]

ret
</code></pre></div>
<p>tick_msg:<br />
    .asciz "Tick!\n"</p>
<p>결과<br />
Tick!<br />
Tick!<br />
Tick!</p>
<h3 id="mmu">&gt; mmu(메모리 매니지먼트 유닛)<a class="headerlink" href="#mmu" title="Permanent link">&para;</a></h3>
<p>물리 주소와 가상 주소를 매핑해준다. 따라서 유저모드/커널모드를 분리하여 프로세스를 격리하고 메모리를 보호한다.<br />
step 1. 페이지 테이블 준비<br />
arm64에서는 기본으로 L1 -&gt; L2 -&gt; L3 테이블로 계층화를 하지만 여기선 identity mapping으로 구성<br />
step 2. mmu 레지스터<br />
TTBRO_EL1 : 페이지 테이블 베이스 주소<br />
TCR_EL1 : 주소 크기 설정<br />
MAIR_EL1 : 메모리 속성<br />
SCTLR_EL1 : mmu 활성화</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>