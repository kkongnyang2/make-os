
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../6-PCB/">
      
      
        <link rel="next" href="../8-mkfs/">
      
      
      <link rel="icon" href="../logo.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>7 uart - Make-OS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../soft-era.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="apple" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#xv6-riscv-uartc" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Make-OS" class="md-header__button md-logo" aria-label="Make-OS" data-md-component="logo">
      
  <img src="../logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Make-OS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              7 uart
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="apple" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Soft Era"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Soft Era" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20.71 4.63-1.34-1.34c-.37-.39-1.02-.39-1.41 0L9 12.25 11.75 15l8.96-8.96c.39-.39.39-1.04 0-1.41M7 14a3 3 0 0 0-3 3c0 1.31-1.16 2-2 2 .92 1.22 2.5 2 4 2a4 4 0 0 0 4-4 3 3 0 0 0-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="soft" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Apple Classic"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Apple Classic" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20.71 4.63-1.34-1.34c-.37-.39-1.02-.39-1.41 0L9 12.25 11.75 15l8.96-8.96c.39-.39.39-1.04 0-1.41M7 14a3 3 0 0 0-3 3c0 1.31-1.16 2-2 2 .92 1.22 2.5 2 4 2a4 4 0 0 0 4-4 3 3 0 0 0-3-3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../1-vm/" class="md-tabs__link">
        
  
  
    
  
  1 vm

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../10-mini-os/" class="md-tabs__link">
        
  
  
    
  
  10 mini os

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../2-hw/" class="md-tabs__link">
        
  
  
    
  
  2 hw

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../3-kernel/" class="md-tabs__link">
        
  
  
    
  
  3 kernel

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../4-MMU/" class="md-tabs__link">
        
  
  
    
  
  4 MMU

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../5-trap/" class="md-tabs__link">
        
  
  
    
  
  5 trap

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../6-PCB/" class="md-tabs__link">
        
  
  
    
  
  6 PCB

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  7 uart

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../8-mkfs/" class="md-tabs__link">
        
  
  
    
  
  8 mkfs

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../9-build/" class="md-tabs__link">
        
  
  
    
  
  9 build

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Make-OS" class="md-nav__button md-logo" aria-label="Make-OS" data-md-component="logo">
      
  <img src="../logo.svg" alt="logo">

    </a>
    Make-OS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../1-vm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 vm
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../10-mini-os/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    10 mini os
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../2-hw/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 hw
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../3-kernel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 kernel
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../4-MMU/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4 MMU
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../5-trap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5 trap
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../6-PCB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    6 PCB
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    7 uart
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    7 uart
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#xv6-riscv-uartc" class="md-nav__link">
    <span class="md-ellipsis">
      xv6-riscv의 uart.c 파일을 읽어보자
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xv6-riscv의 uart.c 파일을 읽어보자">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uart" class="md-nav__link">
    <span class="md-ellipsis">
      목표: uart 이해
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0" class="md-nav__link">
    <span class="md-ellipsis">
      0&gt; 개념 정리
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1&gt; 용어 정리
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2&gt; 흐름 정리
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-uartc" class="md-nav__link">
    <span class="md-ellipsis">
      3&gt; uart.c
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../8-mkfs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    8 mkfs
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../9-build/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    9 build
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#xv6-riscv-uartc" class="md-nav__link">
    <span class="md-ellipsis">
      xv6-riscv의 uart.c 파일을 읽어보자
    </span>
  </a>
  
    <nav class="md-nav" aria-label="xv6-riscv의 uart.c 파일을 읽어보자">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uart" class="md-nav__link">
    <span class="md-ellipsis">
      목표: uart 이해
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0" class="md-nav__link">
    <span class="md-ellipsis">
      0&gt; 개념 정리
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1&gt; 용어 정리
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2&gt; 흐름 정리
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-uartc" class="md-nav__link">
    <span class="md-ellipsis">
      3&gt; uart.c
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>7 uart</h1>

<h2 id="xv6-riscv-uartc">xv6-riscv의 uart.c 파일을 읽어보자</h2>
<h3 id="uart">목표: uart 이해</h3>
<p>작성자: kkongnyang2 작성일: 2025-06-26</p>
<hr />
<h3 id="0">0&gt; 개념 정리</h3>
<p>uart는 cpu, 메모리 쪽의 병렬 데이터를 두 가닥(TX보내기와 RX받기)의 직렬 신호로 바꿔 주는 컨버터다. 원래 칩 내부에서는 64개의 선으로 클럭마다 64비트를 보낸다. 하지만 외부에서는 클럭을 동기화할 수 없기에 비동기 직렬로 전송하고, 8비트(1바이트)마다 체크를 한다. 그리고 이러한 선들을 버스라고 부르는데, 이미 cpu에서는 하드웨어 제작 단계에서 이러한 uart mmio의 존재를 알고 있기에 주소 0x10000000으로 사용한다.</p>
<p><div class="highlight"><pre><span></span><code>  CPU 파이프라인 (5~10 stage 예)          메모리·I/O
┌─ IF ─┬─ ID ─┬─ EX/AGU ─┬─ MEM  ─┬─ WB ─┐
| 명령  | 해석  | 주소계산   |캐시/TLB | 결과  |
└──────┴──────┴──────────┴────────┴──────┘
               ▲
               │ 가상주소(VA)
          ┌────┴────┐
          │ TLB HIT │ 1~2 cycle
          └────┬────┘
               │ 물리주소(PA)
               ▼
         L1 D-Cache HIT? 1~4 cycle
               │
        ┌──────┴───────┐
        │     MISS     │ (10~20 cyc L2, 30~50 cyc L3, 100~200 cyc DRAM…)
        └──────────────┘
</code></pre></div><br />
버스? 누가 언제 DRAM에 말을 걸 수 있는지 규정하는 교통로 규칙이다. CPU 말고도 디스크나 I/O 컨트롤러가 버스 마스터가 되어 직접 메모리를 읽고 쓰는 메커니즘이다. CPU는 목적지, 길이, 옵션을 레지스터에 써서 미션을 주고, 인터럽트가 올때까지 다른일을 하며 기다린다. 마스터는 "나 DRAM 0x12340000 4KB 읽을래" 라고 외치는 쪽,(과거에는 CPU 한명이었지만 현대에는 DMA,GPU,NIC 등 다수), 슬레이브는 주소가 자기사이즈 범위에 들어오면 "여긴 DRAM이야" "여긴 UART야" 응답하는 측이다. 만약 동시에 두 마스터가 버스를 요구하면 우선순위로 차례를 지정한다.<br />
<div class="highlight"><pre><span></span><code>층                      물리 폭               한번에 다루는 논리 단위
CPU &lt;-&gt; L1/L2/L3        64~512bit           캐리라인 64B를 버스트로 여러 클럭
CPU &lt;-&gt; DDRS DRAM       64bit+ECC           64bit*burst16 = 128B 메모리 버스트
PCle 4*4                4lane*1bit(복호시128)    126B TLP 페이로드, 256B MPS 추천
UART                    1bit(TX), 1bit(RX)      8bit payload+1start+1stop
</code></pre></div><br />
<div class="highlight"><pre><span></span><code>     ┌─ Start(0) │  bit0 … bit7 │ Stop(1) ─┐
TX───┤────────────┴─────────────┴───────────┤→ 시간
</code></pre></div><br />
<div class="highlight"><pre><span></span><code>      ┌───── 물리층(선) ─────┐
ADDR[31:0]  DATA[63:0]  CLK  RESET …          ← parallel AXI 예시
TX   RX  GND  REFCLK                       ← serial PCIe 예시
      └────────────────────┘
              ▲
              ▼
      ┌─── 프로토콜층 ───┐
• 버스 요청/허가 (arbitration)  
• 주소 → 타깃 장치 인식 (decoding)  
• 읽기 vs 쓰기 구분 (control)  
• 데이터 크기·정렬·burst 규칙 …  
      └───────────────────┘
</code></pre></div></p>
<hr />
<h3 id="1">1&gt; 용어 정리</h3>
<div class="highlight"><pre><span></span><code>baud rate                       // 초당 전송 비트 수. xv6은 38.4kbis/s이다
THR/RHR(transmit/receive holding register)  // cpu에 오가는 바이트를 담는 8bit 레지스터
LSR(line status register)       // TX_IDLE, RX_READY 같은 플래그로 하드웨어 상태 보고
IER/ISR(interrupt enable/status)  // 어떤 이벤트로 인터럽트가 왔고 뭘 활성화햇는지 저장
LCR(line control)               // 데이터 길이, stop비트, parity, baud-latch 모드 전환 등을 지정
FIFO                            // 추가된 16B 하드웨어 버퍼. FCR_FIFO_ENABLE로 키고 FCR_FIFO_CLEAR로 초기
Uart interrupt                  // PLIC이 IRQ 10번으로 cpu에 전달
top/bottom half                 // 인터럽트 진입 직후 처리(top)과 버퍼 비우기 깨우기 등 후처리(bottom)
console subsystem               // 실제 하드웨어는 uart.c, 라인 처리는 console.c
</code></pre></div>
<hr />
<h3 id="2">2&gt; 흐름 정리</h3>
<div class="highlight"><pre><span></span><code>+-------------+        +-------------+         +----------------+
| user space  | sys_write → consolewrite() →   | circular TX buf|
|  printf()   |        |  (console.c) |         | uart_tx_buf[]  |
+-------------+        +-------------+         +----------------+
                                     │ (1)enqueue &amp; uartstart()
                                     ▼
                                uartputc()
                                     │            ┌─┐ HW raises
                                     │ (top-half) │ │ IRQ
                                     ▼            ▼ ▼
                               uartstart()──▶[THR empty?]──▶ PLIC ─► devintr()
                                     ▲                            │
                                     │                            ▼
 (2) sleep(&amp;uart_tx_r) &lt;── buffer full?                    uartintr()
                                     ▲                            │
    wakeup(&amp;uart_tx_r) ◄─────────────┘         while(uartgetc()!=-1) consoleintr()
</code></pre></div>
<hr />
<h3 id="3-uartc">3&gt; uart.c</h3>
<div class="highlight"><pre><span></span><code><span class="c1">//</span>
<span class="c1">// low-level driver routines for 16550a UART.</span>
<span class="c1">//</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;types.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;param.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;memlayout.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;riscv.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;spinlock.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;proc.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;defs.h&quot;</span>

<span class="c1">// the UART control registers are memory-mapped</span>
<span class="c1">// at address UART0. this macro returns the</span>
<span class="c1">// address of one of the registers.</span>
<span class="cp">#define Reg(reg) ((volatile unsigned char *)(UART0 + (reg)))</span>

<span class="c1">// the UART control registers.</span>
<span class="c1">// some have different meanings for</span>
<span class="c1">// read vs write.</span>
<span class="c1">// see http://byterunner.com/16550.html</span>
<span class="cp">#define RHR 0                 </span><span class="c1">// receive holding register (for input bytes)</span>
<span class="cp">#define THR 0                 </span><span class="c1">// transmit holding register (for output bytes)</span>
<span class="cp">#define IER 1                 </span><span class="c1">// interrupt enable register</span>
<span class="cp">#define IER_RX_ENABLE (1&lt;&lt;0)</span>
<span class="cp">#define IER_TX_ENABLE (1&lt;&lt;1)</span>
<span class="cp">#define FCR 2                 </span><span class="c1">// FIFO control register</span>
<span class="cp">#define FCR_FIFO_ENABLE (1&lt;&lt;0)</span>
<span class="cp">#define FCR_FIFO_CLEAR (3&lt;&lt;1) </span><span class="c1">// clear the content of the two FIFOs</span>
<span class="cp">#define ISR 2                 </span><span class="c1">// interrupt status register</span>
<span class="cp">#define LCR 3                 </span><span class="c1">// line control register</span>
<span class="cp">#define LCR_EIGHT_BITS (3&lt;&lt;0)</span>
<span class="cp">#define LCR_BAUD_LATCH (1&lt;&lt;7) </span><span class="c1">// special mode to set baud rate</span>
<span class="cp">#define LSR 5                 </span><span class="c1">// line status register</span>
<span class="cp">#define LSR_RX_READY (1&lt;&lt;0)   </span><span class="c1">// input is waiting to be read from RHR</span>
<span class="cp">#define LSR_TX_IDLE (1&lt;&lt;5)    </span><span class="c1">// THR can accept another character to send</span>

<span class="cp">#define ReadReg(reg) (*(Reg(reg)))</span>
<span class="cp">#define WriteReg(reg, v) (*(Reg(reg)) = (v))</span>

<span class="c1">// the transmit output buffer.</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">spinlock</span><span class="w"> </span><span class="n">uart_tx_lock</span><span class="p">;</span>
<span class="cp">#define UART_TX_BUF_SIZE 32</span>
<span class="kt">char</span><span class="w"> </span><span class="n">uart_tx_buf</span><span class="p">[</span><span class="n">UART_TX_BUF_SIZE</span><span class="p">];</span>
<span class="n">uint64</span><span class="w"> </span><span class="n">uart_tx_w</span><span class="p">;</span><span class="w"> </span><span class="c1">// write next to uart_tx_buf[uart_tx_w % UART_TX_BUF_SIZE]</span>
<span class="n">uint64</span><span class="w"> </span><span class="n">uart_tx_r</span><span class="p">;</span><span class="w"> </span><span class="c1">// read next from uart_tx_buf[uart_tx_r % UART_TX_BUF_SIZE]</span>

<span class="k">extern</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">panicked</span><span class="p">;</span><span class="w"> </span><span class="c1">// from printf.c</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">uartstart</span><span class="p">();</span>

<span class="kt">void</span>
<span class="nf">uartinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// disable interrupts.</span>
<span class="w">  </span><span class="n">WriteReg</span><span class="p">(</span><span class="n">IER</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// special mode to set baud rate.</span>
<span class="w">  </span><span class="n">WriteReg</span><span class="p">(</span><span class="n">LCR</span><span class="p">,</span><span class="w"> </span><span class="n">LCR_BAUD_LATCH</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// LSB for baud rate of 38.4K.</span>
<span class="w">  </span><span class="n">WriteReg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// MSB for baud rate of 38.4K.</span>
<span class="w">  </span><span class="n">WriteReg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// leave set-baud mode,</span>
<span class="w">  </span><span class="c1">// and set word length to 8 bits, no parity.</span>
<span class="w">  </span><span class="n">WriteReg</span><span class="p">(</span><span class="n">LCR</span><span class="p">,</span><span class="w"> </span><span class="n">LCR_EIGHT_BITS</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// reset and enable FIFOs.</span>
<span class="w">  </span><span class="n">WriteReg</span><span class="p">(</span><span class="n">FCR</span><span class="p">,</span><span class="w"> </span><span class="n">FCR_FIFO_ENABLE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">FCR_FIFO_CLEAR</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// enable transmit and receive interrupts.</span>
<span class="w">  </span><span class="n">WriteReg</span><span class="p">(</span><span class="n">IER</span><span class="p">,</span><span class="w"> </span><span class="n">IER_TX_ENABLE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">IER_RX_ENABLE</span><span class="p">);</span>

<span class="w">  </span><span class="n">initlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uart_tx_lock</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uart&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// add a character to the output buffer and tell the</span>
<span class="c1">// UART to start sending if it isn&#39;t already.</span>
<span class="c1">// blocks if the output buffer is full.</span>
<span class="c1">// because it may block, it can&#39;t be called</span>
<span class="c1">// from interrupts; it&#39;s only suitable for use</span>
<span class="c1">// by write().</span>
<span class="kt">void</span>
<span class="nf">uartputc</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uart_tx_lock</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">panicked</span><span class="p">){</span>
<span class="w">    </span><span class="k">for</span><span class="p">(;;)</span>
<span class="w">      </span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="n">uart_tx_w</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">uart_tx_r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">UART_TX_BUF_SIZE</span><span class="p">){</span>
<span class="w">    </span><span class="c1">// buffer is full.</span>
<span class="w">    </span><span class="c1">// wait for uartstart() to open up space in the buffer.</span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uart_tx_r</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">uart_tx_lock</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">uart_tx_buf</span><span class="p">[</span><span class="n">uart_tx_w</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">UART_TX_BUF_SIZE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">  </span><span class="n">uart_tx_w</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">uartstart</span><span class="p">();</span>
<span class="w">  </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uart_tx_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="c1">// alternate version of uartputc() that doesn&#39;t </span>
<span class="c1">// use interrupts, for use by kernel printf() and</span>
<span class="c1">// to echo characters. it spins waiting for the uart&#39;s</span>
<span class="c1">// output register to be empty.</span>
<span class="kt">void</span>
<span class="nf">uartputc_sync</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">push_off</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">panicked</span><span class="p">){</span>
<span class="w">    </span><span class="k">for</span><span class="p">(;;)</span>
<span class="w">      </span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// wait for Transmit Holding Empty to be set in LSR.</span>
<span class="w">  </span><span class="k">while</span><span class="p">((</span><span class="n">ReadReg</span><span class="p">(</span><span class="n">LSR</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">LSR_TX_IDLE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">;</span>
<span class="w">  </span><span class="n">WriteReg</span><span class="p">(</span><span class="n">THR</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>

<span class="w">  </span><span class="n">pop_off</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// if the UART is idle, and a character is waiting</span>
<span class="c1">// in the transmit buffer, send it.</span>
<span class="c1">// caller must hold uart_tx_lock.</span>
<span class="c1">// called from both the top- and bottom-half.</span>
<span class="kt">void</span>
<span class="nf">uartstart</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">uart_tx_w</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">uart_tx_r</span><span class="p">){</span>
<span class="w">      </span><span class="c1">// transmit buffer is empty.</span>
<span class="w">      </span><span class="n">ReadReg</span><span class="p">(</span><span class="n">ISR</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="n">ReadReg</span><span class="p">(</span><span class="n">LSR</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">LSR_TX_IDLE</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">      </span><span class="c1">// the UART transmit holding register is full,</span>
<span class="w">      </span><span class="c1">// so we cannot give it another byte.</span>
<span class="w">      </span><span class="c1">// it will interrupt when it&#39;s ready for a new byte.</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uart_tx_buf</span><span class="p">[</span><span class="n">uart_tx_r</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">UART_TX_BUF_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="n">uart_tx_r</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// maybe uartputc() is waiting for space in the buffer.</span>
<span class="w">    </span><span class="n">wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uart_tx_r</span><span class="p">);</span>

<span class="w">    </span><span class="n">WriteReg</span><span class="p">(</span><span class="n">THR</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// read one input character from the UART.</span>
<span class="c1">// return -1 if none is waiting.</span>
<span class="kt">int</span>
<span class="nf">uartgetc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">ReadReg</span><span class="p">(</span><span class="n">LSR</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x01</span><span class="p">){</span>
<span class="w">    </span><span class="c1">// input data is ready.</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ReadReg</span><span class="p">(</span><span class="n">RHR</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// handle a uart interrupt, raised because input has</span>
<span class="c1">// arrived, or the uart is ready for more output, or</span>
<span class="c1">// both. called from devintr().</span>
<span class="kt">void</span>
<span class="nf">uartintr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// read and process incoming characters.</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uartgetc</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="n">consoleintr</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// send buffered characters.</span>
<span class="w">  </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uart_tx_lock</span><span class="p">);</span>
<span class="w">  </span><span class="n">uartstart</span><span class="p">();</span>
<span class="w">  </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uart_tx_lock</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "content.code.copy", "header.autohide"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>